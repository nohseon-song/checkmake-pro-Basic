<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CheckMake PRO-Basic</title>

  <!-- GitHub Pages BASE 경로 (리포 이름) -->
  <script>window.__BASE__ = "/checkmake-pro-Basic/";</script>

  <!-- Manifest & Icons (동적 경로 주입) -->
  <link rel="manifest" id="mf">
  <link rel="apple-touch-icon" id="apple">
  <link rel="icon" sizes="192x192" id="ico192">
  <link rel="icon" sizes="256x256" id="ico256">
  <link rel="icon" sizes="512x512" id="ico512">
  <meta name="theme-color" content="#2563eb">

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b;
      --primary:#2563eb; --primary2:#3b82f6;
      --shadow:0 16px 60px rgba(37,99,235,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,"Noto Sans KR",sans-serif;
      display:grid;place-items:center;
    }
    .card{
      width:min(560px,92vw);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:32px 28px;
    }
    .logo{width:84px;height:84px;border-radius:20px;display:block;margin:0 auto 10px auto}
    h1{margin:8px 0 4px 0;text-align:center;font-size:28px}
    .sub{color:var(--muted);text-align:center;margin-bottom:18px}
    .btn{
      appearance:none;border:0;border-radius:12px;
      padding:14px 18px;font-weight:800;font-size:15px;letter-spacing:.2px;cursor:pointer;
      transition:transform .06s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .primary{color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary2))}
    .ghost{background:#eef2ff;color:#1e40af}
    .row{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .hint{color:var(--muted);text-align:center;margin-top:10px}
    .err{color:#b91c1c;text-align:center;display:none;margin-top:10px;font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <main class="card">
    <img id="logo" class="logo" alt="CheckMake logo" />
    <h1>CheckMake PRO-Basic</h1>
    <div class="sub">Professional-Engineering Insight By SNS</div>

    <div class="row">
      <button id="installBtn" class="btn primary" style="display:none">홈 화면에 추가</button>
      <button id="openBtn" class="btn ghost">앱 열기</button>
    </div>
    <div id="hint" class="hint" style="display:none">주소창 우측의 <b>앱 설치</b> 버튼을 눌러 설치할 수 있어요.</div>
    <div id="err" class="err"></div>
  </main>

  <script>
    const BASE = window.__BASE__;
    const APP_URL = "https://script.google.com/macros/s/AKfycbzqztdLghQX5HRnqGmVyPcgZNqQw3hINjW3YxZpACzO7XOTaY1nJonFBUTq9bnhuKjTzg/exec"; // 원본 앱 주소로 필요시 교체

    // 아이콘/매니페스트 경로 주입 (절대경로)
    document.getElementById('mf').href     = `${BASE}manifest.json`;
    document.getElementById('apple').href  = `${BASE}icons/icon-192.png`;
    document.getElementById('ico192').href = `${BASE}icons/icon-192.png`;
    document.getElementById('ico256').href = `${BASE}icons/icon-256.png`;
    document.getElementById('ico512').href = `${BASE}icons/icon-512.png`;
    document.getElementById('logo').src    = `${BASE}icons/icon-512.png`;

    // Service Worker 등록
    let swReady = Promise.resolve();
    if ('serviceWorker' in navigator) {
      swReady = navigator.serviceWorker.register(`${BASE}sw.js`).catch(()=>{});
    }

    // beforeinstallprompt 이벤트로 설치 버튼 제어
    let deferredPrompt = null;
    const $install = document.getElementById('installBtn');
    const $hint = document.getElementById('hint');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $install.style.display = 'inline-block';
      $hint.style.display = 'none';
      console.log('[PWA] beforeinstallprompt fired');
    });

    // 설치 버튼 클릭
    $install.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      await deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      console.log('[PWA] userChoice:', choice);
      deferredPrompt = null;
      // 설치 수락 후엔 아이콘으로 실행하므로 여기선 버튼 숨김
      $install.style.display = 'none';
    });

    // 앱 열기 → 원본으로 이동
    document.getElementById('openBtn').addEventListener('click', async () => {
      await swReady;
      location.href = APP_URL;
    });

    // 이미 PWA 모드면 바로 이동
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    if (isStandalone) location.replace(APP_URL);

    // 헬스체크 + 대체 안내
    (async function healthCheck(){
      const err = document.getElementById('err');
      const res = await Promise.allSettled([
        fetch(`${BASE}manifest.json`, {method:'HEAD', cache:'no-store'}),
        fetch(`${BASE}sw.js`, {method:'HEAD', cache:'no-store'}),
        fetch(`${BASE}icons/icon-512.png`, {method:'HEAD', cache:'no-store'})
      ]);
      const fails = [];
      if (!(res[0].status==='fulfilled' && res[0].value.ok)) fails.push('manifest');
      if (!(res[1].status==='fulfilled' && res[1].value.ok)) fails.push('service worker');
      if (!(res[2].status==='fulfilled' && res[2].value.ok)) fails.push('icons');

      if (fails.length){ err.style.display='block'; err.textContent = `리소스 경로 오류(${fails.join(', ')}). BASE='${BASE}'`; }
      // install 이벤트가 안 왔다면 대체 힌트 표시(크롬 주소창 설치 버튼 유도)
      setTimeout(()=>{ if (!$install.offsetParent) $hint.style.display = 'block'; }, 800);
    })();
  </script>
</body>
</html>
